generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum ItemCondition {
  NEW
  LIKE_NEW
  USED
}

enum ItemStatus {
  AVAILABLE
  IN_CLAIM
  COMPLETED
}

enum ItemVerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELED
}

enum PointType {
  EARN
  SPEND
  TOPUP
}

model User {
  id            String          @id @default(uuid())
  fullname      String
  studentId     String          @unique
  email         String          @unique
  password      String
  major         String?
  contact       String?
  avatarUrl     String?
  role          Role            @default(USER)
  points        Int             @default(100)
  isActive      Boolean  @default(true)
  createdAt     DateTime        @default(now())

  tokenVersion  Int             @default(0)

  items         Item[]
  sentTx        Transaction[]  @relation("SentTransaction")
  receivedTx    Transaction[]  @relation("ReceivedTransaction")
  pointHistory  PointHistory[]
  notifications Notification[]
  wishlist      Wishlist[]

  conversations Conversation[]
  messages      Message[]
  seenMessages  Message[]       @relation("Seen")

}

model Category {
  id    Int    @id @default(autoincrement())
  name  String @unique

  items Item[]
}

model Item {
  id                   String                  @id @default(uuid())
  title                String
  slug                 String                  @unique
  shortDescription     String                  @db.Text
  description          String                  @db.Text
  condition            ItemCondition
  status               ItemStatus              @default(AVAILABLE)
  verificationStatus   ItemVerificationStatus  @default(PENDING)
  pointValue            Int
  imageUrl              String?
  createdAt            DateTime                @default(now())

  ownerId              String
  categoryId           Int

  owner                User        @relation(fields: [ownerId], references: [id])
  category             Category    @relation(fields: [categoryId], references: [id])
  transaction          Transaction?
  wishlistedBy         Wishlist[]
}

model Transaction {
  id          String            @id @default(uuid())
  itemId      String            @unique
  fromUserId  String
  toUserId    String
  points      Int
  status      TransactionStatus @default(PENDING)
  createdAt   DateTime          @default(now())

  item        Item @relation(fields: [itemId], references: [id])
  fromUser    User @relation("SentTransaction", fields: [fromUserId], references: [id])
  toUser      User @relation("ReceivedTransaction", fields: [toUserId], references: [id])
}

model PointHistory {
  id          String    @id @default(uuid())
  userId      String
  amount      Int
  type        PointType
  description String?
  createdAt   DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String
  itemId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  item Item @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId])
}

model Conversation {
  id            String    @id @default(uuid()) 
  createdAt     DateTime  @default(now())
  lastMessageAt DateTime  @default(now())
  name          String?
  isGroup       Boolean?
  
  messages      Message[]

  users         User[] 
}

model Message {
  id             String       @id @default(cuid())
  body           String?      @db.Text 
  image          String?
  createdAt      DateTime     @default(now())
     
  seen           User[]       @relation("Seen")

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
}